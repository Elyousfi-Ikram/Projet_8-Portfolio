<section id="projets" class="projects-section section-bg-light d-flex flex-column justify-content-center align-items-center"
    [class.visible]="isVisible" aria-labelledby="projects-title">
    <div class="projects-container my-0 mx-auto p-5 w-100 rounded-5">
        <header class="projects-header text-center mb-5 rounded-5">
            <h1 id="projects-title" class="projects-title mb-3 fw-bold">
                Mes projets
                <span class="title-accent"></span>
            </h1>
            <div class="title-underline mx-auto mt-0 mb-3 rounded-2" aria-hidden="true"></div>
            <p class="projects-subtitle mb-4 fw-light fs-5">Découvrez une sélection de mes réalisations</p>
        </header>

        <div class="projects-layout d-flex align-items-start gap-4">
            <aside class="project-detail-panel col-8 bg-white rounded-5 p-5 position-relative"
                *ngIf="selectedProject as p">
                <div class="detail-header d-flex justify-content-center mb-4">
                    <h2 class="detail-title text-center fw-bold">{{ p.titleProjet }}</h2>
                </div>

                <div class="detail-section" *ngIf="p.infoProjet">
                    <h3 class="section-title d-inline-flex align-items-center gap-2 fs-6 text-uppercase fw-bold">Description du
                        projet</h3>
                    <div class="section-content mt-3">{{ p.infoProjet }}</div>
                </div>

                <div class="detail-section" *ngIf="(p.objectifs?.length ?? 0) > 0">
                    <h3 class="section-title d-inline-flex align-items-center gap-2 fs-6 text-uppercase fw-bold">Objectifs du
                        projet</h3>
                    <ul class="objectives-list mt-3">
                        <li class="objective-item mb-2" *ngFor="let s of p.objectifs">{{ s }}</li>
                    </ul>
                </div>

                <div class="detail-section" *ngIf="(p.maquettes?.length ?? 0) > 0">
                    <h3 class="section-title d-inline-flex align-items-center gap-2 fs-6 text-uppercase preview">
                        Aperçu du projet
                    </h3>
                    <div class="images-grid d-grid gap-4 mt-4">
                        <button class="image-container bg-white rounded-5 overflow-hidden position-relative"
                            *ngFor="let m of visibleMaquettes(p); let i = index; trackBy: trackByIndex"
                            (click)="openCarousel(i)">
                            <img [src]="m" [alt]="'Maquette ' + (i + 1)" class="project-image w-100 d-block" loading="lazy" />
                            <div class="image-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center text-white">
                                <i class="fas fa-eye"></i>
                            </div>
                        </button>
                    </div>

                    <div class="show-more-container" *ngIf="(p.maquettes?.length ?? 0) > 4">
                        <button class="show-more-btn mt-2 px-4 py-2 bg-transparent cursor-pointer border-0 fst-italic fs-6 fw-semibold"
                            (click)="toggleShowAllImages()" [attr.aria-label]="showMoreAria">
                            <span class="plus-icon" aria-hidden="true">{{ showAllImages ? '−' : '+' }}</span>
                            {{ showAllImages ? 'Voir moins' : 'Voir plus' }}
                        </button>
                    </div>
                </div>

                <div class="detail-actions d-flex gap-3 mt-5 justify-content-start" *ngIf="p.URLcode || p.URLsite">
                    <a [href]="p.URLcode" target="_blank" rel="noopener noreferrer"
                        class="github-link d-inline-flex align-items-center gap-2 text-white py-2 px-3 rounded-1 text-decoration-none fw-bold"
                        *ngIf="p.URLcode">
                        Voir le code source
                    </a>
                    <a [href]="p.URLsite" target="_blank" rel="noopener noreferrer"
                        class="github-link d-inline-flex align-items-center gap-2 text-white py-2 px-3 rounded-1 text-decoration-none fw-bold"
                        *ngIf="p.URLsite">
                        Voir le site
                    </a>
                </div>
            </aside>

            <!-- Colonne des cartes -->
            <div class="projects-grid col-4 d-flex flex-column gap-4 overflow-y-scroll rounded-5">
                <div class="project-item position-relative bg-white rounded-5 w-100"
                    *ngFor="let project of projects; let index = index" [style.animationDelay]="(index * 0.1) + 's'">
                    <div class="projet w-100 h-100 position-relative d-block">
                        <button type="button"
                            class="btn position-relative w-100 d-block overflow-hidden rounded-5 cursor-pointer text-decoration-none bg-white border-0 p-0"
                            (click)="selectProject(project)">
                            <img class="project-image w-100 object-fit-cover" [src]="resolveImagePath(project.img)"
                                [alt]="project.title" loading="lazy" />

                            <div
                                class="project-overlay position-absolute opacity-100 d-flex align-items-center justify-content-center flex-column text-center text-white p-4">
                                <div class="project-content">
                                    <h3 class="project-title position-relative w-100 z-3 rounded-4 p-3 fs-5">{{
                                        project.title }}</h3>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Carrousel (fusionné depuis ProjectCardComponent) -->
<div class="carousel position-fixed d-grid" *ngIf="carouselOpen && (selectedProject?.maquettes?.length ?? 0) > 0"
    (click)="onCarouselBackdropClick()">
    <div class="carousel-content position-relative bg-white rounded-5 overflow-hidden d-flex align-items-center justify-content-center"
        (click)="$event.stopPropagation()">
        <button
            class="carousel-close d-flex align-items-center justify-content-center position-absolute border-0 bg-transparent fs-1 cursor-pointer"
            (click)="closeCarousel()" aria-label="Fermer le carousel">
            ×
        </button>

        <button
            class="carousel-nav carousel-prev position-absolute top-50 translate-middle-y rounded-circle text-white border-0 d-grid cursor-pointer fw-bold"
            *ngIf="(selectedProject?.maquettes?.length ?? 0) > 1" (click)="prevImage()" aria-label="Image précédente">
            ‹
        </button>
        <button
            class="carousel-nav carousel-next position-absolute top-50 translate-middle-y rounded-circle text-white border-0 d-grid cursor-pointer fw-bold"
            *ngIf="(selectedProject?.maquettes?.length ?? 0) > 1" (click)="nextImage()" aria-label="Image suivante">
            ›
        </button>

        <img class="carousel-image w-100 h-100 object-fit-contain"
            [src]="resolveMaquettePath(((selectedProject?.maquettes ?? [])[currentImageIndex]) ?? '')"
            [alt]="'Maquette ' + (currentImageIndex + 1)" loading="lazy" />

        <div class="carousel-counter position-absolute right-0 text-white px-2 py-1 rounded-2 fs-6"
            *ngIf="(selectedProject?.maquettes?.length ?? 0) > 1">
            {{ currentImageIndex + 1 }} / {{ selectedProject?.maquettes?.length }}
        </div>
    </div>
</div>